<?xml version="1.0" encoding="utf-8"?>
<Project>

  <PropertyGroup>
    <NugetExePath>$(NuGetPackageRoot)NuGet.CommandLine\4.9.2\tools</NugetExePath>
    <NuGetSources>$(NuGetSources);$(NuGetPackageRoot)</NuGetSources>
  </PropertyGroup>
  
  <!-- General properties -->
  <PropertyGroup>
    <_PackageInstallDirectory>$(OutputPath)vl\packs\</_PackageInstallDirectory>
    <_LocalPackagesFolder>$(MsBuildThisFileDirectory)..\..\..\packages-build\</_LocalPackagesFolder>
    <_BuildingLocally>false</_BuildingLocally>
    <_ManifestNamespace>http://schemas.microsoft.com/packaging/2013/05/nuspec.xsd</_ManifestNamespace>
  </PropertyGroup>
  
  <!-- Add local packages folder if building locally -->
  <PropertyGroup Condition="Exists('$(_LocalPackagesFolder)NUGET_NEEDS_ME.txt')">
    <_BuildingLocally>true</_BuildingLocally>
    <NuGetSources>$(NuGetSources);$(_LocalPackagesFolder)</NuGetSources>
    <_ManifestNamespace>http://schemas.microsoft.com/packaging/2012/06/nuspec.xsd</_ManifestNamespace>
  </PropertyGroup>

  <Target Name="_GetVLXenkoManifestFromPackage" Condition=" '$(_BuildingLocally)' == 'false' ">
    <PropertyGroup>
      <_VLXenkoManifest>$(MsBuildThisFileDirectory)..\vl.xenko.integration.nuspec</_VLXenkoManifest>
    </PropertyGroup>
  </Target>

  <Target Name="_GetVLXenkoManifestFromProject" Condition=" '$(_BuildingLocally)' == 'true' ">
    <MSBuild Projects="$(MsBuildThisFileDirectory)..\VL.Xenko.Integration.csproj"
             Properties="Configuration=$(Configuration)"
             Targets="GetTargetPath" >
      <Output TaskParameter="TargetOutputs" ItemName="_IntegrationAssembly" />
    </MSBuild>
    <PropertyGroup>
      <_VLXenkoManifest>@(_IntegrationAssembly->'%(RootDir)%(Directory)%(Filename)').nuspec</_VLXenkoManifest>
    </PropertyGroup>
  </Target>

  <Target Name="_GetVLXenkoManifest" DependsOnTargets="_GetVLXenkoManifestFromPackage;_GetVLXenkoManifestFromProject">
    <Message Importance="high" Text="Using $(_VLXenkoManifest)" />
  </Target>

  <Target Name="GetVLXenkoVersion" DependsOnTargets="_GetVLXenkoManifest">
    <XmlPeek Namespaces="&lt;Namespace Prefix='n' Uri='$(_ManifestNamespace)'/&gt;" 
             XmlInputPath="$(_VLXenkoManifest)" 
             Query="/n:package/n:metadata/n:version/text()">
      <Output TaskParameter="Result" PropertyName="VLXenkoVersion" />
    </XmlPeek>
    <Message Importance="high" Text="Using VL.Xenko version $(VLXenkoVersion)" />
  </Target>

  <Target Name="GetVLVersion"
          DependsOnTargets="GetVLXenkoVersion">
    <XmlPeek Namespaces="&lt;Namespace Prefix='n' Uri='$(_ManifestNamespace)'/&gt;" 
             XmlInputPath="$(_VLXenkoManifest)" 
             Query="/n:package/n:metadata/n:dependencies/n:group/n:dependency[@id='VL.Meta.Gamma']/@version">
      <Output TaskParameter="Result" PropertyName="VLVersion" />
    </XmlPeek>
    <Message Importance="high" Text="Using VL version $(VLVersion)" />
  </Target>

  <Target Name="_GetVLXenkoEffectLibManifestFromPackage"
      DependsOnTargets="GetVLXenkoVersion"
      Condition=" '$(_BuildingLocally)' == 'false' ">
    <PropertyGroup>
      <_VLXenkoEffectLibManifest>$(NuGetPackageRoot)VL.Xenko.EffectLib\$(VLXenkoVersion)\vl.xenko.effectlib.nuspec</_VLXenkoEffectLibManifest>
    </PropertyGroup>
  </Target>

  <Target Name="_GetVLXenkoEffectLibManifestFromProject"
        DependsOnTargets="GetVLXenkoVersion"
        Condition=" '$(_BuildingLocally)' == 'true' ">
    <MSBuild Projects="$(MsBuildThisFileDirectory)..\..\VL.Xenko.EffectLib\src\VL.Xenko.EffectLib.csproj"
             Properties="Configuration=$(Configuration)"
             Targets="GetTargetPath" >
      <Output TaskParameter="TargetOutputs" ItemName="_EffectLibAssembly" />
    </MSBuild>
    <PropertyGroup>
      <_VLXenkoEffectLibManifest>@(_EffectLibAssembly->'%(RootDir)%(Directory)%(Filename)').nuspec</_VLXenkoEffectLibManifest>
    </PropertyGroup>
    <Message Importance="high" Text="Using $(_VLXenkoEffectLibManifest)" />
  </Target>

  <Target Name="GetVLXenkoEffectLibManifest"
          DependsOnTargets="_GetVLXenkoEffectLibManifestFromPackage;_GetVLXenkoEffectLibManifestFromProject">
    <PropertyGroup>
      <_VLXenkoEffectLibOutputManifest>$(_PackageInstallDirectory)VL.Xenko.EffectLib.$(VLXenkoVersion)\VL.Xenko.EffectLib.nuspec</_VLXenkoEffectLibOutputManifest>
    </PropertyGroup>
  </Target>

  <Target Name="InstallVLIntoPacksFolder" 
          DependsOnTargets="GetVLVersion" 
          Inputs="$(NuGetPackageRoot)VL.Meta.Gamma\$(VLVersion)\vl.meta.gamma.nuspec"
          Outputs="$(_PackageInstallDirectory)VL.Meta.Gamma.$(VLVersion)\VL.Meta.Gamma.nuspec">
    <Message Importance="high" Text="Installing VL.Meta.Gamma.$(VLVersion) to $(_PackageInstallDirectory)" />
    <NuGetInstall ToolPath="$(NugetExePath)"
                  Package="VL.Meta.Gamma"
                  Version="$(VLVersion)"
                  OutputDirectory="$(_PackageInstallDirectory)"
                  Source="$(NuGetSources)"
                  PackageSaveMode="nuspec"
                  PreRelease="true" />
    <PropertyGroup>
      <_PackagesInstalled>true</_PackagesInstalled>
    </PropertyGroup>
  </Target>

  <Target Name="InstallVLXenkoIntoPacksFolder" 
          DependsOnTargets="GetVLXenkoEffectLibManifest"
          Inputs="$(_VLXenkoEffectLibManifest)"
          Outputs="$(_VLXenkoEffectLibOutputManifest)">
    <Message Importance="high" Text="Installing VL.Xenko.EffectLib.$(VLXenkoVersion) to $(_PackageInstallDirectory)" />
    <NuGetInstall ToolPath="$(NugetExePath)"
                  Package="VL.Xenko.EffectLib"
                  Version="$(VLXenkoVersion)"
                  OutputDirectory="$(_PackageInstallDirectory)"
                  Source="$(NuGetSources)"
                  PackageSaveMode="nuspec"
                  PreRelease="true" />
    <Touch Files="$(_VLXenkoEffectLibOutputManifest)" />
    <PropertyGroup>
      <_PackagesInstalled>true</_PackagesInstalled>
    </PropertyGroup>
  </Target>
 
  <Target Name="InstallPacksIntoContentFolder" 
          AfterTargets="Build" 
          DependsOnTargets="InstallVLXenkoIntoPacksFolder;InstallVLIntoPacksFolder">
    <ItemGroup>
      <_AllDirectories Include="$([System.IO.Directory]::GetDirectories('$(_PackageInstallDirectory)', '*', System.IO.SearchOption.TopDirectoryOnly))" />
      <_VLDirectories Include="$([System.IO.Directory]::GetDirectories('$(_PackageInstallDirectory)', 'VL.*', System.IO.SearchOption.TopDirectoryOnly))" />
      <_DirectoriesToDelete Include="@(_AllDirectories)" Exclude="@(_VLDirectories)" />
    </ItemGroup>
    <RemoveDir Directories="@(_DirectoriesToDelete)" />
    <Message Importance="high" Text="Removing all non-VL packages @(_DirectoriesToDelete)" />
  </Target>
  
</Project>